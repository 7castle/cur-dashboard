AWSTemplateFormatVersion: "2010-09-09"

Description: CUR Dashboard app stack launched into an existing VPC including ASG with timed scale-up / scale-down policy.

Parameters:
  CURBucket:
    Type: String
    Description: S3 bucket configured for Cost and Usage Reports
    MinLength: 2

  ReportName:
    Type: String
    Description: The CUR Report Name setup in the billing dashboard
    MinLength: 2

  ReportPath:
    Type: String
    Description: The CUR Report Path setup in the billing dashboard
    MinLength: 2

  CURUploadBucket:
    Type: String
    Description: OPTIONAL S3 bucket for storing converted CUR files (only use this is your CUR bucket is invalid for use with Athena i.e. contains a underscore)

  InstanceType:
    Type: String
    Description: Instance Type to run. Larger instances required for larger CUR's
    Default: c4.large
    AllowedValues:
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge

  SpotPrice:
    Type: Number
    Default: 0.50
    MinValue: 0.01
    Description: The Maximum price for the instance you want to pay (Note you will be charged based on the current price)

  Schedule:
    Type: Number
    Default: 4
    MinValue: 1
    Description: Time gap (in hours) between CUR automatic processing (the lower, the more frequent the conversion will occur)

  GitURL:
    Type: String
    Default: "https://github.com/andyfase/CURdashboard.git"
    MinLength: 2
    Description: "URL of the git repo that will be checked out and used when configuring the EC2 instance, use your cloned repo."

  GitBranch:
    Type: String
    Default: "master"
    MinLength: 2
    Description: "Branch of your GIT repo that the EC2 instance will checkout. Change this from 'master' to test out seperate code branches before they are merged to master"

  KeypairName:
    Type: AWS::EC2::KeyPair::KeyName

  AvailabilityZones:
    Type:  "List<AWS::EC2::AvailabilityZone::Name>"
    Description: "List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved. 1 or 3 AZs are used for this deployment."

  VPCCIDR:
    Type: String
    Description: "CIDR Block for the VPC"
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/23"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(23))$"
    Default: "10.0.0.0/23"

  PrivateSubnet1CIDR:
    Type: String
    Description: "CIDR block for private subnet 1 located in Availability Zone 1."
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/27"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(27))$"
    Default: "10.0.0.0/27"

  PrivateSubnet2CIDR:
    Type: String
    Description: "CIDR block for private subnet 1 located in Availability Zone 1."
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/27"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(27))$"
    Default: "10.0.0.32/27"
  
  PublicSubnet1CIDR:
    Type: String
    Description: "CIDR block for public subnet 1 located in Availability Zone 1."
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/27"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(27))$"
    Default: "10.0.1.0/27"
  
  PublicSubnet2CIDR:
    Type: String
    Description: "CIDR block for public subnet 1 located in Availability Zone 1."
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/27"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(27))$"
    Default: "10.0.1.32/27"

  QSResourceTagPrefix:
    Type: String
    Description: "Prefix for resources that are Tagged for CURDashboard"
    ConstraintDescription: "Resource tag prefix can include numbers, lowercase letters, uppercase letters, hyphens (-)."
    AllowedPattern: "^[0-9a-zA-Z-]*$"
    Default: "cur-dashboard"

  QSS3KeyPrefix:
    Type: String
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/). It cannot start or end with a hyphen (-)."
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    Default: "cur-dashboard/"
  
  QSS3BucketName:
    Type: String
    Description: "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Default: "aws-quickstart"

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties: 
      TemplateURL:
        "Fn::Sub": "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template"

      Parameters:
        AvailabilityZones:
           "Fn::Join":
              - ","
              - Ref: AvailabilityZones
        PrivateSubnet1ACIDR:
          Ref: PrivateSubnet1CIDR
        PrivateSubnet2ACIDR:
          Ref: PrivateSubnet2CIDR
        PublicSubnet1CIDR:
          Ref: PublicSubnet1CIDR
        PublicSubnet2CIDR:
          Ref: PublicSubnet2CIDR
        VPCCIDR:
          Ref: VPCCIDR
        KeyPairName:
          Ref: KeypairName

  CURDashboardStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties: 
     TemplateURL:
       Fn::Sub: https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/CURdashboard.yaml
     Parameters:
      QSResourceTagPrefix:
        Ref: QSResourceTagPrefix
      CURBucket:
        Ref: CURBucket
      ReportName:
        Ref: ReportName
      ReportPath:
        Ref: ReportPath
      CURUploadBucket:
        Ref: CURUploadBucket
      InstanceType:
        Ref: InstanceType
      SpotPrice:
        Ref: SpotPrice
      Schedule:
        Ref: Schedule
      GitURL:
        Ref: GitURL
      GitBranch:
        Ref: GitBranch
      KeypairName:
        Ref: KeypairName
      VPCID:
        "Fn::GetAtt":
          - "VPCStack"
          - "Outputs.VPCID"
      Subnet1:
        "Fn::GetAtt":
          - "VPCStack"
          - "Outputs.PublicSubnet1ID"
      Subnet2:
        "Fn::GetAtt":
          - "VPCStack"
          - "Outputs.PublicSubnet2ID"